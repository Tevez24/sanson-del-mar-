{% extends "restaurante_app/base.html" %}

{% block content %}
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Menú Restaurante con Carrito</title>
    <script src="https://unpkg.com/lucide@0.264.0/dist/lucide.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.3/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <style>
      .bg-background {
        background-color: #f9fafb;
      }
      .text-muted-foreground {
        color: #6b7280;
      }
      .text-ocean-blue {
        color: #0ea5e9;
      }
      .text-coral-accent {
        color: #f87171;
      }
      .badge-secondary {
        background-color: #0ea5e9;
        color: white;
        border-radius: 9999px;
        padding: 0 0.5rem;
        font-size: 0.75rem;
      }
      .button-ocean {
        background-color: #0ea5e9;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
      }
      .button-outline {
        border: 1px solid #0ea5e9;
        color: #0ea5e9;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
      }
      .tabs-trigger {
        cursor: pointer;
        padding: 0.5rem 1rem;
        border-bottom: 2px solid transparent;
      }
      .tabs-trigger.active {
        border-color: #0ea5e9;
        font-weight: bold;
      }
      .modal-bg {
        background: rgba(0, 0, 0, 0.5);
      }
    </style>
  </head>

  <body class="bg-background min-h-screen">
    <!-- Navbar Placeholder -->
    <nav class="bg-white shadow py-4 px-6">
      <h1 class="text-2xl font-bold">Navbar</h1>
    </nav>

    <div class="pt-20 pb-16 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Header y carrito -->
      <div class="flex justify-between items-center mb-8">
        <div>
          <h1 class="text-5xl font-bold text-foreground mb-4">Nuestro Menú</h1>
          <p class="text-xl text-muted-foreground">
            Descubre nuestra selección de platos exquisitos
          </p>
        </div>

        <div class="relative" id="cartButton">
          <button id="openCartBtn" class="button-ocean flex items-center relative">
            <svg data-lucide="shopping-cart" class="h-5 w-5 mr-2"></svg>
            Ver Carrito
            <span
              id="cartBadge"
              class="badge-secondary absolute -top-2 -right-2 bg-coral-accent text-white"
              >0</span
            >
          </button>
        </div>
      </div>

      <!-- Tabs -->
      <div class="mb-8">
        <div class="flex gap-2">
          <div id="tabRegular" class="tabs-trigger active">Menú del Restaurante</div>
          <div id="tabCustom" class="tabs-trigger">Crear Menú Mundial</div>
        </div>
      </div>

      <!-- Tab Contents -->
      <div id="tabContents">
        <!-- Menú Regular -->
        <div id="contentRegular">
          <!-- Filtros y búsqueda -->
          <div class="space-y-4 mb-8">
            <div class="flex flex-col sm:flex-row gap-4">
              <div class="relative flex-1">
                <svg
                  data-lucide="search"
                  class="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"
                ></svg>
                <input
                  type="text"
                  placeholder="Buscar platos..."
                  id="searchInput"
                  class="pl-10 border rounded w-full py-2 px-3"
                />
              </div>

              <div id="categoryButtons" class="flex gap-2 flex-wrap">
                <!-- Buttons injected by JS -->
              </div>
            </div>
          </div>

          <!-- Menu Items -->
          <div id="menuItemsContainer" class="space-y-6">
            <!-- Items injected by JS -->
          </div>
        </div>

        <!-- Menú Custom -->
        <div id="contentCustom" class="hidden">
          <div id="customMenuContainer" class="space-y-6"></div>
        </div>
      </div>
    </div>

    <!-- Modal Carrito -->
    <div
      id="cartModal"
      class="fixed inset-0 hidden justify-center items-center modal-bg z-50"
    >
      <div class="bg-white w-full max-w-3xl rounded shadow-lg p-6 relative">
        <button
          id="closeCartBtn"
          class="absolute top-3 right-3 text-gray-500 hover:text-gray-700"
        >
          &times;
        </button>
        <h2 class="text-2xl font-bold mb-4">Mi Carrito</h2>
        <div id="cartItemsContainer" class="space-y-4 max-h-96 overflow-y-auto"></div>
        <div class="mt-4 border-t pt-4">
          <div class="flex justify-between mb-2">
            <span>Subtotal:</span>
            <span id="cartSubtotal">0 COP</span>
          </div>
          <div class="flex justify-between mb-2">
            <span>IVA (19%):</span>
            <span id="cartTax">0 COP</span>
          </div>
          <div class="flex justify-between mb-2">
            <span>Envío:</span>
            <span id="cartShipping">0 COP</span>
          </div>
          <div class="flex justify-between font-bold text-lg mt-2">
            <span>Total:</span>
            <span id="cartTotal">0 COP</span>
          </div>
          <button id="payBtn" class="button-ocean w-full mt-4">Procesar Pago</button>
        </div>
      </div>
    </div>

    <script>
      lucide.replace();

      // ===== Mock Data =====
      const menuItems = [
        {
          id: 1,
          name: "Pizza Margherita",
          category: "Pizzas",
          description: "Pizza clásica con queso y tomate",
          price: 25000,
        },
        {
          id: 2,
          name: "Hamburguesa Clásica",
          category: "Hamburguesas",
          description: "Carne, queso y lechuga",
          price: 20000,
        },
        {
          id: 3,
          name: "Ensalada César",
          category: "Ensaladas",
          description: "Lechuga, pollo y aderezo César",
          price: 15000,
        },
        {
          id: 4,
          name: "Pizza Pepperoni",
          category: "Pizzas",
          description: "Pepperoni y extra queso",
          price: 28000,
        },
      ];

      const state = { items: [], itemCount: 0 };
      const categories = ["Todos", ...Array.from(new Set(menuItems.map((i) => i.category)))];
      let selectedCategory = "Todos";

      // ===== Elements =====
      const searchInput = document.getElementById("searchInput");
      const categoryButtonsDiv = document.getElementById("categoryButtons");
      const menuItemsContainer = document.getElementById("menuItemsContainer");
      const customMenuContainer = document.getElementById("customMenuContainer");
      const cartBadge = document.getElementById("cartBadge");
      const cartModal = document.getElementById("cartModal");
      const openCartBtn = document.getElementById("openCartBtn");
      const closeCartBtn = document.getElementById("closeCartBtn");
      const cartItemsContainer = document.getElementById("cartItemsContainer");
      const cartSubtotal = document.getElementById("cartSubtotal");
      const cartTax = document.getElementById("cartTax");
      const cartShipping = document.getElementById("cartShipping");
      const cartTotal = document.getElementById("cartTotal");
      const payBtn = document.getElementById("payBtn");

      // ===== MenuCard Component =====
      function MenuCard(item) {
        const card = document.createElement("div");
        card.className = "border rounded p-4 bg-white shadow";
        card.innerHTML = `
          <h3 class="font-bold text-lg mb-2">${item.name}</h3>
          <p class="text-muted-foreground mb-2">${item.description}</p>
          <p class="font-semibold mb-2">${item.price} COP</p>
          <button class="button-ocean w-full">Agregar al carrito</button>
        `;
        card.querySelector("button").addEventListener("click", () => addToCart(item));
        return card;
      }

      // ===== Custom Menu Creator =====
      function CustomMenuCreator() {
        const container = document.createElement("div");
        container.className = "p-6 bg-gray-100 rounded";
        container.innerHTML = `
          <h2 class="text-2xl font-bold mb-4">Crea tu Menú Mundial</h2>
          <p>Selecciona tus ingredientes y crea un plato personalizado.</p>
          <div class="mt-4">
            <label class="block mb-2 font-semibold">Nombre del Plato</label>
            <input type="text" class="border rounded w-full py-2 px-3" placeholder="Nombre del plato">
          </div>
          <div class="mt-4">
            <label class="block mb-2 font-semibold">Ingredientes</label>
            <input type="text" class="border rounded w-full py-2 px-3" placeholder="Lista de ingredientes">
          </div>
          <button class="button-ocean mt-4">Agregar al Menú</button>
        `;
        return container;
      }
      customMenuContainer.appendChild(CustomMenuCreator());

      // ===== Render Functions =====
      function renderCategoryButtons() {
        categoryButtonsDiv.innerHTML = "";
        categories.forEach((cat) => {
          const btn = document.createElement("button");
          btn.textContent = cat;
          btn.className = selectedCategory === cat ? "button-ocean" : "button-outline";
          btn.addEventListener("click", () => {
            selectedCategory = cat;
            renderCategoryButtons();
            renderMenuItems();
          });
          categoryButtonsDiv.appendChild(btn);
        });
      }

      function renderMenuItems() {
        const searchTerm = searchInput.value.toLowerCase();
        const filtered = menuItems.filter((item) => {
          const matchesSearch =
            item.name.toLowerCase().includes(searchTerm) ||
            item.description.toLowerCase().includes(searchTerm);
          const matchesCategory = selectedCategory === "Todos" || item.category === selectedCategory;
          return matchesSearch && matchesCategory;
        });

        menuItemsContainer.innerHTML = "";
        const grouped = {};
        filtered.forEach((item) => {
          if (!grouped[item.category]) grouped[item.category] = [];
          grouped[item.category].push(item);
        });

        if (selectedCategory === "Todos") {
          for (const [cat, items] of Object.entries(grouped)) {
            if (items.length === 0) continue;
            const section = document.createElement("div");
            section.className = "space-y-6";

            const title = document.createElement("h2");
            title.textContent = cat;
            title.className = "text-3xl font-bold text-ocean-blue";
            section.appendChild(title);

            const grid = document.createElement("div");
            grid.className = "grid md:grid-cols-2 lg:grid-cols-3 gap-6";

            items.forEach((item) => grid.appendChild(MenuCard(item)));

            section.appendChild(grid);
            menuItemsContainer.appendChild(section);
          }
        } else {
          const section = document.createElement("div");
          section.className = "space-y-6";

          const title = document.createElement("h2");
          title.textContent = selectedCategory;
          title.className = "text-3xl font-bold text-ocean-blue";
          section.appendChild(title);

          const grid = document.createElement("div");
          grid.className = "grid md:grid-cols-2 lg:grid-cols-3 gap-6";

          filtered.forEach((item) => grid.appendChild(MenuCard(item)));

          section.appendChild(grid);
          menuItemsContainer.appendChild(section);
        }
      }

      // ===== Cart Functions =====
      function addToCart(item) {
        const existing = state.items.find((i) => i.id === item.id);
        if (existing) existing.quantity++;
        else state.items.push({ ...item, quantity: 1 });
        updateCartCount();
        renderCartItems();
      }

      function removeFromCart(id) {
        state.items = state.items.filter((i) => i.id !== id);
        updateCartCount();
        renderCartItems();
      }

      function changeQuantity(id, delta) {
        const item = state.items.find((i) => i.id === id);
        if (!item) return;
        item.quantity += delta;
        if (item.quantity <= 0) removeFromCart(id);
        else renderCartItems();
        updateCartCount();
      }

      function updateCartCount() {
        const total = state.items.reduce((sum, i) => sum + i.quantity, 0);
        state.itemCount = total;
        cartBadge.textContent = total;
      }

      function renderCartItems() {
        cartItemsContainer.innerHTML = "";
        const subtotal = state.items.reduce((sum, i) => sum + i.price * i.quantity, 0);
        const tax = subtotal * 0.19;
        const shipping = subtotal > 50000 ? 0 : 5000;
        const total = subtotal + tax + shipping;

        cartSubtotal.textContent = subtotal + " COP";
        cartTax.textContent = tax + " COP";
        cartShipping.textContent = shipping === 0 ? "Gratis" : shipping + " COP";
        cartTotal.textContent = total + " COP";

        state.items.forEach((item) => {
          const div = document.createElement("div");
          div.className = "flex justify-between items-center border-b pb-2";

          div.innerHTML = `
            <div>
              <h4 class="font-semibold">${item.name}</h4>
              <p class="text-sm text-muted-foreground">${item.price} COP c/u</p>
            </div>
            <div class="flex items-center gap-2">
              <button class="px-2 bg-gray-200 rounded">-</button>
              <span>${item.quantity}</span>
              <button class="px-2 bg-gray-200 rounded">+</button>
              <button class="px-2 text-red-500">x</button>
            </div>
          `;

          const [minusBtn, , plusBtn, delBtn] = div.querySelectorAll("button");
          minusBtn.addEventListener("click", () => changeQuantity(item.id, -1));
          plusBtn.addEventListener("click", () => changeQuantity(item.id, 1));
          delBtn.addEventListener("click", () => removeFromCart(item.id));

          cartItemsContainer.appendChild(div);
        });
      }

      // ===== Pay Button =====
      payBtn.addEventListener("click", () => {
        if (state.items.length === 0) return alert("Carrito vacío");

        const now = new Date();
        const orderNumber = `MR-${now.getTime().toString().slice(-8)}`;
        const subtotal = state.items.reduce((sum, i) => sum + i.price * i.quantity, 0);
        const tax = subtotal * 0.19;
        const shipping = subtotal > 50000 ? 0 : 5000;
        const total = subtotal + tax + shipping;

        let content = `RESTAURANTE SAZÓN DEL MAR\nComprobante de Pago\n\nNúmero de Orden: ${orderNumber}\nFecha: ${now.toLocaleDateString()}\n\nPRODUCTOS:\n`;
        state.items.forEach((i) => (content += `${i.name} x${i.quantity} = ${i.price * i.quantity} COP\n`));
        content += `\nSubtotal: ${subtotal} COP\nIVA: ${tax} COP\nEnvío: ${shipping} COP\nTOTAL: ${total} COP\n¡Gracias por tu compra!`;

        const blob = new Blob([content], { type: "text/plain" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `comprobante-${orderNumber}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        state.items = [];
        updateCartCount();
        renderCartItems();
        cartModal.classList.add("hidden");
      });

      // ===== Event Listeners =====
      searchInput.addEventListener("input", renderMenuItems);
      renderCategoryButtons();
      renderMenuItems();

      openCartBtn.addEventListener("click", () => {
        cartModal.classList.remove("hidden");
        renderCartItems();
      });

      closeCartBtn.addEventListener("click", () => cartModal.classList.add("hidden"));

      // Tabs
      const tabRegular = document.getElementById("tabRegular");
      const tabCustom = document.getElementById("tabCustom");
      const contentRegular = document.getElementById("contentRegular");
      const contentCustom = document.getElementById("contentCustom");

      tabRegular.addEventListener("click", () => {
        tabRegular.classList.add("active");
        tabCustom.classList.remove("active");
        contentRegular.classList.remove("hidden");
        contentCustom.classList.add("hidden");
      });

      tabCustom.addEventListener("click", () => {
        tabCustom.classList.add("active");
        tabRegular.classList.remove("active");
        contentCustom.classList.remove("hidden");
        contentRegular.classList.add("hidden");
      });
    </script>
  </body>
</html>
{% endblock %}
