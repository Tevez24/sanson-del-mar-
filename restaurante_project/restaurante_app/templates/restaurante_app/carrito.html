{% extends "restaurante_app/base.html" %}
{% load static %}
{% block content%}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Carrito Interactivo</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.3/dist/tailwind.min.css">
  <script src="https://unpkg.com/lucide@0.264.0/dist/lucide.min.js"></script>
  <style>
    .bg-background { background-color: #f9fafb; }
    .text-foreground { color: #111827; }
    .text-muted-foreground { color: #6b7280; }
    .text-coral-accent { color: #f87171; }
    .text-ocean-blue { color: #0ea5e9; }
    .line-clamp-2 { display: -webkit-box; -webkit-box-orient: vertical; overflow: hidden; }
    .cursor-pointer { cursor: pointer; }
    .badge-secondary { background-color: #e5e7eb; color: #111827; padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-size: 0.75rem; }
    .button { padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; transition: background 0.2s; }
    .button.ocean { background-color: #0ea5e9; color: white; }
    .button.ghost { background-color: transparent; border: 1px solid #d1d5db; }
    .button.outline { border: 1px solid #d1d5db; background: none; }
    .card { border-radius: 0.5rem; background-color: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: transform 0.2s; }
    .card:hover { transform: translateY(-2px); }
    .card-header { padding: 1rem; border-bottom: 1px solid #e5e7eb; }
    .card-content { padding: 1rem; }
    .separator { border-top: 1px solid #e5e7eb; margin: 1rem 0; }
    .product-image { width: 5rem; height: 5rem; border-radius: 0.5rem; background-color: #e5e7eb; overflow: hidden; flex-shrink: 0; }
    .product-image img { width: 100%; height: 100%; object-fit: cover; }
    .toast { position: fixed; bottom: 1rem; right: 1rem; background: #0ea5e9; color: white; padding: 1rem; border-radius: 0.375rem; opacity: 0; transform: translateY(20px); transition: all 0.3s; z-index: 1000; }
    .toast.show { opacity: 1; transform: translateY(0); }
  </style>
</head>
<body class="bg-background min-h-screen">

  <!-- Navbar -->
  <nav class="bg-white p-4 shadow-md fixed w-full top-0 z-50">
    <div class="max-w-6xl mx-auto flex items-center justify-between">
      <a href="/" class="flex items-center space-x-2">
        <img src="{% static 'img/logo.png' %}" alt="Sazón del Mar Logo" class="h-8 w-auto">
        <span class="text-xl font-bold text-blue-600">Sazón del Mar</span>
      </a>
      <div class="flex items-center space-x-6">
        <a href="{% url 'menu' %}" class="text-gray-600 hover:text-blue-600">Menú</a>
        <a href="{% url 'reservas' %}" class="text-gray-600 hover:text-blue-600">Reservas</a>
        <a href="{% url 'contacto' %}" class="text-gray-600 hover:text-blue-600">Contacto</a>
      </div>
    </div>
  </nav>

  <div class="pt-20 pb-16">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">

      <!-- Volver al menú y título -->
      <div class="mb-8">
        <button id="backMenuBtn" class="button ghost mb-4">
          <i data-lucide="arrow-left" class="inline h-4 w-4 mr-2"></i>
          Volver al Menú
        </button>
        <h1 class="text-4xl font-bold text-foreground mb-2">Mi Carrito</h1>
        <p class="text-muted-foreground" id="itemCountText"></p>
      </div>

      <div class="grid lg:grid-cols-3 gap-8">

        <!-- Lista de productos -->
        <div class="lg:col-span-2 space-y-4" id="cartItems"></div>

        <!-- Resumen del pedido y pagos -->
        <div class="space-y-6">

          <!-- Resumen del pedido -->
          <div class="card">
            <div class="card-header"><h2 class="text-xl">Resumen del Pedido</h2></div>
            <div class="card-content space-y-4">
              <div class="flex justify-between"><span>Subtotal:</span><span id="subtotalText"></span></div>
              <div class="flex justify-between"><span>IVA (19%):</span><span id="taxText"></span></div>
              <div class="flex justify-between"><span>Envío:</span><span id="shippingText"></span></div>
              <div class="separator"></div>
              <div class="flex justify-between text-lg font-bold"><span>Total:</span><span class="text-coral-accent" id="totalText"></span></div>
              <div id="freeShippingText" class="text-sm text-muted-foreground bg-gray-100 p-3 rounded-lg hidden">
                <i data-lucide="truck" class="inline h-4 w-4 mr-2"></i>
                Agrega <span id="remainingForFree"></span> más para envío gratis
              </div>
            </div>
          </div>

          <!-- Métodos de pago -->
          <div class="card">
            <div class="card-header"><h2 class="text-lg">Método de Pago</h2></div>
            <div class="card-content space-y-4">
              <div class="space-y-3" id="paymentMethods"></div>
              <button id="payBtn" class="button ocean w-full"></button>
              <div class="text-xs text-muted-foreground text-center">
                <i data-lucide="shield-check" class="inline h-4 w-4 mr-1"></i>
                Pago seguro y protegido
              </div>
            </div>
          </div>

          <!-- Información legal -->
          <div class="card">
            <div class="card-content p-4">
              <div class="text-xs text-muted-foreground space-y-2">
                <div class="flex items-start gap-2">
                  <i data-lucide="download" class="h-3 w-3 mt-0.5 flex-shrink-0"></i>
                  <span>Recibirás un comprobante digital de tu compra</span>
                </div>
                <div class="flex items-start gap-2">
                  <i data-lucide="shield-check" class="h-3 w-3 mt-0.5 flex-shrink-0"></i>
                  <span>Proteción al consumidor según Ley 1480 de 2011</span>
                </div>
              </div>
            </div>
          </div>

        </div>

      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <script>
    lucide.replace(); // Renderiza los iconos

    // Toast
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2500);
    }

    // Estado del carrito
    let state = {
      items: [
        { id: '1', name: 'Ceviche', price: 20000, quantity: 2, category: 'Mariscos', description: 'Delicioso ceviche fresco', image: 'https://via.placeholder.com/80' },
        { id: '2', name: 'Lomo Saltado', price: 25000, quantity: 1, category: 'Carne', description: 'Lomo saltado peruano', image: 'https://via.placeholder.com/80' }
      ],
      total: 65000,
      itemCount: 3
    };

    const cartItemsDiv = document.getElementById('cartItems');
    const itemCountText = document.getElementById('itemCountText');
    const subtotalText = document.getElementById('subtotalText');
    const taxText = document.getElementById('taxText');
    const shippingText = document.getElementById('shippingText');
    const totalText = document.getElementById('totalText');
    const freeShippingText = document.getElementById('freeShippingText');
    const remainingForFree = document.getElementById('remainingForFree');
    const payBtn = document.getElementById('payBtn');
    const paymentMethodsDiv = document.getElementById('paymentMethods');

    let paymentMethod = 'credit-card';

    const formatPrice = (price) => new Intl.NumberFormat('es-CO', { style:'currency', currency:'COP', minimumFractionDigits:0 }).format(price);

    const payments = [
      { id: 'credit-card', name: 'Tarjeta de Crédito', icon: 'credit-card' },
      { id: 'mercado-pago', name: 'Mercado Pago', icon: 'shield-check' },
      { id: 'paypal', name: 'PayPal', icon: 'shield-check' }
    ];

    const calculateTotals = () => {
      const subtotal = state.items.reduce((sum,it)=>sum+it.price*it.quantity,0);
      const tax = subtotal * 0.19;
      const shipping = subtotal > 50000 ? 0 : 5000;
      const total = subtotal + tax + shipping;

      subtotalText.textContent = formatPrice(subtotal);
      taxText.textContent = formatPrice(tax);
      shippingText.textContent = shipping === 0 ? 'Gratis' : formatPrice(shipping);
      totalText.textContent = formatPrice(total);

      if(shipping > 0){
        freeShippingText.classList.remove('hidden');
        remainingForFree.textContent = formatPrice(50000 - subtotal);
      } else {
        freeShippingText.classList.add('hidden');
      }

      payBtn.innerHTML = `<i data-lucide="credit-card" class="h-4 w-4 mr-2"></i> Pagar ${formatPrice(total)}`;
      lucide.replace();
      return { subtotal, tax, shipping, total };
    };

    const renderCartItems = () => {
      cartItemsDiv.innerHTML = '';
      state.items.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'card overflow-hidden';
        itemDiv.innerHTML = `
          <div class="card-content p-6 flex gap-4">
            <div class="product-image">
              ${item.image ? `<img src="${item.image}" alt="${item.name}" />` : ''}
            </div>
            <div class="flex-1 min-w-0">
              <div class="flex items-start justify-between mb-2">
                <div>
                  <h3 class="font-semibold text-foreground">${item.name}</h3>
                  <span class="badge-secondary mt-1">${item.category}</span>
                </div>
                <button class="text-red-500 removeBtn"><i data-lucide="trash-2" class="h-4 w-4"></i></button>
              </div>
              <p class="text-sm text-muted-foreground mb-3 line-clamp-2">${item.description}</p>
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <button class="button outline minusBtn"><i data-lucide="minus" class="h-3 w-3"></i></button>
                  <span class="font-medium w-8 text-center quantity">${item.quantity}</span>
                  <button class="button outline plusBtn"><i data-lucide="plus" class="h-3 w-3"></i></button>
                </div>
                <div class="text-right">
                  <div class="text-sm text-muted-foreground">${formatPrice(item.price)} c/u</div>
                  <div class="font-bold text-coral-accent">${formatPrice(item.price * item.quantity)}</div>
                </div>
              </div>
            </div>
          </div>
        `;
        cartItemsDiv.appendChild(itemDiv);

        const minusBtn = itemDiv.querySelector('.minusBtn');
        const plusBtn = itemDiv.querySelector('.plusBtn');
        const removeBtn = itemDiv.querySelector('.removeBtn');
        const quantitySpan = itemDiv.querySelector('.quantity');

        minusBtn.addEventListener('click', () => {
          if(item.quantity > 1) item.quantity--;
          quantitySpan.textContent = item.quantity;
          calculateTotals();
        });
        plusBtn.addEventListener('click', () => {
          item.quantity++;
          quantitySpan.textContent = item.quantity;
          calculateTotals();
        });
        removeBtn.addEventListener('click', () => {
          state.items = state.items.filter(it => it.id !== item.id);
          renderCartItems();
          calculateTotals();
          itemCountText.textContent = state.items.length ? `${state.items.reduce((sum,it)=>sum+it.quantity,0)} productos` : 'Tu carrito está vacío';
          showToast('Producto eliminado del carrito');
        });
      });
      lucide.replace();
    };

    // Render métodos de pago
    payments.forEach(method => {
      const label = document.createElement('label');
      label.className = 'flex items-center space-x-3 cursor-pointer';
      label.innerHTML = `
        <input type="radio" name="payment" value="${method.id}" ${paymentMethod===method.id?'checked':''} class="text-ocean-blue"/>
        <i data-lucide="${method.icon}" class="h-5 w-5 text-muted-foreground"></i>
        <span>${method.name}</span>
      `;
      paymentMethodsDiv.appendChild(label);
      label.querySelector('input').addEventListener('change', e=> paymentMethod=e.target.value);
    });

    // Descargar comprobante
    payBtn.addEventListener('click', () => {
      payBtn.disabled = true;
      payBtn.textContent = 'Procesando...';
      setTimeout(()=>{
        const now = new Date();
        const orderNumber = `MR-${now.getTime().toString().slice(-8)}`;
        const totals = calculateTotals();
        const receipt = `
Restaurante Sazón del Mar
Comprobante de Pago 

Número de Orden: ${orderNumber}
Fecha: ${now.toLocaleDateString('es-CO')}
Hora: ${now.toLocaleTimeString('es-CO')}

PRODUCTOS:
═══════════════════════════════════════
${state.items.map(it => 
  `${it.name}
  Cantidad: ${it.quantity}
  Precio: ${formatPrice(it.price)}
  Subtotal: ${formatPrice(it.price * it.quantity)}
  ───────────────────────────────────────`
).join('\n')}

RESUMEN:
═══════════════════════════════════════
Subtotal: ${formatPrice(totals.subtotal)}
IVA (19%): ${formatPrice(totals.tax)}
Envío: ${totals.shipping===0?'Gratis':formatPrice(totals.shipping)}
TOTAL: ${formatPrice(totals.total)}

Método de Pago: ${paymentMethod==='credit-card'?'Tarjeta de Crédito':paymentMethod==='mercado-pago'?'Mercado Pago':'PayPal'}

¡Gracias por elegir Restaurante Sazón del Mar!
Disfruta tu experiencia gastronómica.

═══════════════════════════════════════
        `;
        const blob = new Blob([receipt], {type:'text/plain'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `comprobante-${orderNumber}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(a.href);

        state.items = [];
        calculateTotals();
        renderCartItems();
        itemCountText.textContent = 'Tu carrito está vacío';
        showToast('¡Pago exitoso! Comprobante descargado');
        payBtn.disabled = false;
      },1500);
    });

    // Inicializar
    renderCartItems();
    calculateTotals();
    itemCountText.textContent = `${state.itemCount} ${state.itemCount === 1 ? 'producto' : 'productos'} en tu carrito`;
    document.getElementById('backMenuBtn').addEventListener('click', ()=>window.location.href='/menu');

  </script>

</body>
</html>
{% endblock %}